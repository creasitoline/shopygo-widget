<script type="module">
    // ... (Mantieni import e config Firebase invariati) ...

    // FUNZIONE CARICAMENTO FOTO CON COMPRESSIONE
    document.getElementById('file-input').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // Creiamo un canvas per rimpicciolire l'immagine se è troppo grande
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800; // Qualità ottima ma leggera
                let width = img.width;
                let height = img.height;

                if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
                
                // Trasformiamo in un link leggero (JPG invece di PNG)
                const dataurl = canvas.toDataURL("image/jpeg", 0.7);
                document.getElementById('f-img').value = dataurl;
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // TASTO SALVA (Modificato per sbloccarsi subito)
    document.getElementById('btn-salva-prodotto').onclick = async () => {
        const btn = document.getElementById('btn-salva-prodotto');
        btn.innerText = "SALVATAGGIO...";
        btn.disabled = true;

        const id = document.getElementById('f-id').value;
        const data = {
            titolo: document.getElementById('f-titolo').value,
            prezzo: document.getElementById('f-prezzo').value,
            immagine: document.getElementById('f-img').value,
            descrizione: document.getElementById('f-desc').value,
            link_amazon: document.getElementById('f-link').value,
            tipo: document.getElementById('f-tipo').value,
            categoria: document.getElementById('f-categoria').value,
            tag: utenteAttivo.tag,
            autore: utenteAttivo.nome,
            data_agg: new Date()
        };

        try {
            if(id) {
                await updateDoc(doc(db, "prodotti", id), data);
            } else {
                await addDoc(collection(db, "prodotti"), data);
            }
            closeModal();
            caricaProdotti();
        } catch (error) {
            alert("Errore nel salvataggio: " + error.message);
        } finally {
            btn.innerText = "PUBBLICA";
            btn.disabled = false;
        }
    };

    // TASTO ELIMINA (Pulito e diretto)
    document.getElementById('btn-elimina-prodotto').onclick = async () => {
        const id = document.getElementById('f-id').value;
        if(!id) return;
        
        if(confirm("⚠️ Vuoi davvero eliminare questo prodotto?")) {
            try {
                await deleteDoc(doc(db, "prodotti", id));
                closeModal();
                caricaProdotti();
            } catch (error) {
                alert("Errore eliminazione: " + error.message);
            }
        }
    };

    // ... (Mantieni le altre funzioni caricaProdotti e apriModifica uguali) ...
</script>
